<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amigo Secreto çµæœ</title>
<style>
body { font-family:"Noto Sans JP",sans-serif; text-align:center; margin-top:40px; background:#fffaf5; color:#333; }
#receiver { font-size:2em; margin-top:30px; transition: all 0.4s ease; }
#spinner { font-size:1.5em; color:#888; margin-top:20px; }
button { background:#e44; color:white; border:none; padding:8px 18px; border-radius:8px; cursor:pointer; font-size:1em; }
button:hover { background:#c22; }
input { padding:8px; border-radius:6px; border:1px solid #aaa; width:180px; }
</style>
</head>
<body>
<h1>ğŸ ã‚ãªãŸã®ç›¸æ‰‹ ğŸ</h1>
<div id="content"></div>
<div id="spinner"></div>
<div id="receiver"></div>

<script>
const giver = new URLSearchParams(location.search).get('giver');
if(!giver){ document.body.innerHTML="URLãŒä¸æ­£ã§ã™"; throw ''; }

const content = document.getElementById("content");
const spinner = document.getElementById("spinner");
const receiverBox = document.getElementById("receiver");

content.innerHTML = `
<p>${giver} ã•ã‚“ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
<input type="password" id="pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
<input type="password" id="pw2" placeholder="ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
<button id="btn">çµæœã‚’è¦‹ã‚‹</button>
<div id="msg"></div>
`;

let memberNames = [];

// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‚åŠ è€…ãƒªã‚¹ãƒˆå–å¾—
async function loadMembers() {
  const res = await fetch("/api/list");
  const data = await res.json();
  memberNames = data.map(x => x.name);
}
loadMembers();

document.getElementById("btn").onclick = async () => {
  const pw = document.getElementById("pw").value;
  const pw2 = document.getElementById("pw2").value;

  if(!pw) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  // åˆå›è¨­å®šæ™‚ã¯2å›å…¥åŠ›ã‚’ç¢ºèª
  if(pw2 !== undefined && pw !== pw2){
    return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“");
  }

  const res = await fetch("/api/result?giver=" + encodeURIComponent(giver), {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({password: pw})
  });

  const msg = document.getElementById("msg");
  if(!res.ok){
    msg.textContent = await res.text();
    return;
  }

  const data = await res.json();

  // å…¥åŠ›æ¬„ã‚’éè¡¨ç¤ºã«ã—ã¦æŠ½é¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  document.getElementById("pw").style.display="none";
  document.getElementById("pw2").style.display="none";
  document.getElementById("btn").style.display="none";
  msg.innerHTML = `<p>æŠ½é¸ä¸­...</p>`;

  if(memberNames.length === 0) memberNames = ["å¤ªéƒ","èŠ±å­","å¥ä¸€","çœŸç”±ç¾","å¤§è¼”","ã•ã‚†ã‚Š","åœ­å¾","ã¿ã‚†ã"];

  let count = 0;
  const interval = setInterval(()=>{
    const randomName = memberNames[Math.floor(Math.random()*memberNames.length)];
    spinner.textContent = "ğŸ² " + randomName + " ğŸ²";
    count++;
    if(count>15){
      clearInterval(interval);
      spinner.textContent="";
      receiverBox.innerHTML=`<h2>ğŸ‰ ${data.receiver} ğŸ‰</h2>`;
    }
  },120);
};
</script>
</body>
</html>
