<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amigo Secreto é †ç•ªæŠ½é¸ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f9fafb; padding:1em; text-align:center; }
h1{font-size:1.6em; margin-bottom:1em;}
button{padding:0.8em 1.5em;font-size:1em;margin:0.5em;border:none;border-radius:0.5em;background:#2563eb;color:white;cursor:pointer;}
button:hover{background:#1e40af;}
ul{list-style:none;padding:0;margin-top:1em;}
li{background:white;margin:0.5em auto;padding:0.8em;border-radius:0.5em;max-width:500px;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
canvas{margin-top:0.5em;}
a{color:#2563eb;word-break:break-all;}
</style>
</head>
<body>

<h1>ğŸ Amigo Secreto é †ç•ªæŠ½é¸ ğŸ</h1>

<div id="main">
  <p>å‚åŠ è€…ãƒªã‚¹ãƒˆã¯ <code>data/names.json</code> ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™</p>
  <button id="nextBtn">æ¬¡ã®äººã‚’æŠ½é¸ã™ã‚‹</button>
  <button id="downloadBtn" style="display:none;">çµæœã‚’JSONã§ä¿å­˜</button>

  <h2>æŠ½é¸çŠ¶æ³</h2>
  <ul id="result"></ul>
</div>

<script>
const params = new URLSearchParams(location.search);

// --- å€‹åˆ¥ãƒªãƒ³ã‚¯ç”»é¢ ---
if(params.has('to')){
  const name = decodeURIComponent(atob(params.get('to')));
  document.getElementById('main').innerHTML = `
    <h2>ğŸ ã‚ãªãŸã¸ã®ãŠç›¸æ‰‹ ğŸ</h2>
    <p style="font-size:1.2em;">ã‚ãªãŸãŒãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚’è´ˆã‚‹ã®ã¯ï¼š</p>
    <h1 style="color:#2563eb;">${name}</h1>
    <p><a href="${location.origin}${location.pathname}">â† æŠ½é¸ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></p>
  `;
} else {

  let members = [];
  let receivers = [];
  let nextIndex = 0;
  let pairs = [];

  // LocalStorageå¾©å…ƒ
  const savedPairs = JSON.parse(localStorage.getItem("pairs")||"[]");
  const savedIndex = parseInt(localStorage.getItem("next_index")||"0");

  if(savedPairs.length>0){
    pairs = savedPairs;
    nextIndex = savedIndex;
    showPairs(pairs);
  }

  // --- åå‰èª­ã¿è¾¼ã¿ ---
  async function loadNames(){
    const res = await fetch('data/names.json');
    const data = await res.json();
    members = data.members;
    if(receivers.length===0){
      receivers = [...members];
    }
  }

  loadNames();

  // --- æŠ½é¸å‡¦ç† ---
  function drawNext(){
    if(nextIndex >= members.length){
      alert("å…¨å“¡æŠ½é¸æ¸ˆã¿ã§ã™ï¼");
      return;
    }

    const giver = members[nextIndex];

    // æ®‹ã‚Šã®å—å–äººã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
    const available = receivers.filter(r => !pairs.some(p => p.receiver===r));
    const i = Math.floor(Math.random() * available.length);
    const receiver = available[i];

    pairs.push({giver, receiver});
    nextIndex++;

    // LocalStorageã«ä¿å­˜
    localStorage.setItem("pairs", JSON.stringify(pairs));
    localStorage.setItem("next_index", nextIndex);

    showPairs(pairs);
  }

  // --- çµæœè¡¨ç¤º ---
  function showPairs(pairs){
    const ul = document.getElementById('result');
    ul.innerHTML = '';
    pairs.forEach((p,i)=>{
      const data = btoa(encodeURIComponent(p.receiver));
      const link = `${location.origin}${location.pathname}?to=${data}`;
      const li = document.createElement('li');
      li.innerHTML = `<b>${p.giver}</b> ã•ã‚“ç”¨ãƒªãƒ³ã‚¯ï¼š
        <a href="${link}" target="_blank">ã“ã¡ã‚‰ã‚’ã‚¿ãƒƒãƒ—</a>
        <br><canvas id="qr_${i}"></canvas>`;
      ul.appendChild(li);
      QRCode.toCanvas(document.getElementById(`qr_${i}`), link, {width:100});
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¡¨ç¤º
    if(pairs.length>0){
      document.getElementById('downloadBtn').style.display='inline-block';
    }
  }

  // --- JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
  function downloadJSON(data){
    const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "amigo_result.json";
    link.click();
  }

  document.getElementById('nextBtn').addEventListener('click', drawNext);
  document.getElementById('downloadBtn').addEventListener('click', ()=>{downloadJSON(pairs)});
}
</script>

</body>
</html>
