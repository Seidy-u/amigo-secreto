<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amigo Secreto é †ç•ªæŠ½é¸ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f9fafb; padding:1em; text-align:center; }
h1{font-size:1.6em; margin-bottom:1em;}
button{padding:0.8em 1.5em;font-size:1em;margin:0.5em;border:none;border-radius:0.5em;background:#2563eb;color:white;cursor:pointer;}
button:hover{background:#1e40af;}
canvas{margin-top:0.5em;}
</style>
</head>
<body>

<h1>ğŸ Amigo Secreto é †ç•ªæŠ½é¸ ğŸ</h1>

<div id="main">
  <button id="nextBtn">æ¬¡ã®äººã‚’æŠ½é¸ã™ã‚‹</button>
  <div id="drawResult" style="margin-top:2em;"></div>
</div>

<script>
const params = new URLSearchParams(location.search);

// --- å€‹åˆ¥ãƒªãƒ³ã‚¯ç”»é¢ ---
if(params.has('to')){
  const name = decodeURIComponent(atob(params.get('to')));
  document.getElementById('main').innerHTML = `
    <h2>ğŸ ã‚ãªãŸã¸ã®ãŠç›¸æ‰‹ ğŸ</h2>
    <p style="font-size:1.2em;">ã‚ãªãŸãŒãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚’è´ˆã‚‹ã®ã¯ï¼š</p>
    <h1 style="color:#2563eb;">${name}</h1>
  `;
} else {

  // å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’å¤‰æ•°ã§å®šç¾©ï¼ˆã“ã“ã‚’å¤‰æ›´ã™ã‚Œã°è‡ªå‹•ã§åæ˜ ï¼‰
  let members = ["å¤ªéƒ", "èŠ±å­", "å¥ä¸€", "çœŸç”±ç¾"];
  let receivers = [...members];
  let nextIndex = 0;
  let pairs = [];

  // LocalStorageå¾©å…ƒ
  const savedPairs = JSON.parse(localStorage.getItem("pairs")||"[]");
  const savedIndex = parseInt(localStorage.getItem("next_index")||"0");

  if(savedPairs.length>0){
    pairs = savedPairs;
    nextIndex = savedIndex;
    // æ—¢ã«æŠ½é¸æ¸ˆã¿ã®å—å–äººã‚’é™¤å¤–
    const used = pairs.map(p=>p.receiver);
    receivers = members.filter(m=>!used.includes(m));
  }

  function updateNextMessage(){
    const mainDiv = document.getElementById('main');
    if(nextIndex < members.length){
      const giver = members[nextIndex];
      mainDiv.querySelector('#nextBtn').textContent = `æ¬¡ã¯ ${giver} ã•ã‚“ãŒæŠ½é¸`;
    } else {
      mainDiv.querySelector('#nextBtn').textContent = `å…¨å“¡æŠ½é¸æ¸ˆã¿`;
    }
  }

  function drawNext(){
    if(nextIndex >= members.length){
      alert("å…¨å“¡æŠ½é¸æ¸ˆã¿ã§ã™ï¼");
      return;
    }

    const giver = members[nextIndex];
    const i = Math.floor(Math.random() * receivers.length);
    const receiver = receivers[i];

    pairs.push({giver, receiver});
    receivers.splice(i,1);
    nextIndex++;

    localStorage.setItem("pairs", JSON.stringify(pairs));
    localStorage.setItem("next_index", nextIndex);

    const drawDiv = document.getElementById('drawResult');
    drawDiv.innerHTML = `
      <p>${giver} ã•ã‚“ã®æŠ½é¸çµæœã¯ã“ã¡ã‚‰ï¼š</p>
      <a href="${location.origin}${location.pathname}?to=${btoa(encodeURIComponent(receiver))}" target="_blank">çµæœã‚’è¦‹ã‚‹</a>
      <br><canvas id="qr"></canvas>
    `;
    QRCode.toCanvas(document.getElementById('qr'), `${location.origin}${location.pathname}?to=${btoa(encodeURIComponent(receiver))}`, {width:120});

    updateNextMessage();
  }

  document.getElementById('nextBtn').addEventListener('click', drawNext);

  updateNextMessage();
}
</script>

</body>
</html>
